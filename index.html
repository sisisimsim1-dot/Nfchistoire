<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio NFC Player</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Icônes simplifiées en SVG
        const Icons = {
            Music: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
            ),
            Settings: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m-6-6h6m6 0h6"></path>
                </svg>
            ),
            Scan: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                    <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                    <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                    <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                </svg>
            ),
            Play: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
            ),
            Pause: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
            ),
            Volume2: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
            ),
            Upload: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            ),
            Trash2: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            ),
            Tag: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
            ),
            Link: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
            ),
            FolderOpen: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
            ),
            Edit2: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            ),
            Check: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            ),
            X: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            ),
            Lock: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            )
        };

        function NFCAudioApp() {
            const [mode, setMode] = useState('player');
            const [audioFiles, setAudioFiles] = useState([]);
            const [nfcTags, setNfcTags] = useState({});
            const [categories] = useState(['Tous', 'Musique', 'Podcast', 'Enregistrement']);
            const [currentAudio, setCurrentAudio] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [nfcSupported, setNfcSupported] = useState(false);
            const [scanMessage, setScanMessage] = useState('');
            const audioRef = useRef(null);
            const [selectedFile, setSelectedFile] = useState(null);
            const [waitingForTag, setWaitingForTag] = useState(false);
            const [filterCategory, setFilterCategory] = useState('Tous');
            const [editingFile, setEditingFile] = useState(null);
            const [editName, setEditName] = useState('');
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const [volume, setVolume] = useState(1);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [password, setPassword] = useState('');
            const [passwordError, setPasswordError] = useState(false);

            useEffect(() => {
                if ('NDEFReader' in window) {
                    setNfcSupported(true);
                }
            }, []);

            const handlePasswordSubmit = () => {
                if (password === '1234') {
                    setMode('admin');
                    setShowPasswordModal(false);
                    setPassword('');
                    setPasswordError(false);
                } else {
                    setPasswordError(true);
                    setTimeout(() => setPasswordError(false), 2000);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('audio/')) {
                    const url = URL.createObjectURL(file);
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        url: url,
                        category: 'Enregistrement',
                        duration: 0
                    };
                    
                    const audio = new Audio(url);
                    audio.addEventListener('loadedmetadata', () => {
                        newFile.duration = audio.duration;
                        setAudioFiles([...audioFiles, newFile]);
                    });
                }
            };

            const startNFCLinking = (fileId) => {
                setSelectedFile(fileId);
                setWaitingForTag(true);
                setScanMessage('🌿 Approchez un tag NFC pour le lier...');
                startNFCReader(fileId);
            };

            const startNFCReader = async (linkFileId = null) => {
                if (!nfcSupported) {
                    setScanMessage('❌ NFC non supporté sur cet appareil');
                    return;
                }

                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    
                    setIsScanning(true);
                    setScanMessage(linkFileId ? '🌿 Approchez un tag NFC...' : '✨ En attente de scan NFC...');

                    ndef.onreading = (event) => {
                        const tagId = event.serialNumber;
                        
                        if (linkFileId) {
                            setNfcTags({...nfcTags, [tagId]: linkFileId});
                            setScanMessage('✅ Tag lié avec succès !');
                            setWaitingForTag(false);
                            setSelectedFile(null);
                            setTimeout(() => setScanMessage(''), 3000);
                        } else {
                            const fileId = nfcTags[tagId];
                            if (fileId) {
                                const file = audioFiles.find(f => f.id === fileId);
                                if (file) {
                                    playAudio(file);
                                    setScanMessage('🎵 Lecture : ' + file.name);
                                    setTimeout(() => setScanMessage(''), 3000);
                                } else {
                                    setScanMessage('⚠️ Aucun fichier lié à ce tag');
                                    setTimeout(() => setScanMessage(''), 3000);
                                }
                            } else {
                                setScanMessage('❓ Tag NFC non reconnu');
                                setTimeout(() => setScanMessage(''), 3000);
                            }
                        }
                    };

                    ndef.onreadingerror = () => {
                        setScanMessage('❌ Erreur de lecture NFC');
                        setTimeout(() => setScanMessage(''), 3000);
                    };

                } catch (error) {
                    setScanMessage('❌ Erreur NFC: ' + error.message);
                    setIsScanning(false);
                    setWaitingForTag(false);
                }
            };

            const playAudio = (file) => {
                if (audioRef.current) {
                    audioRef.current.pause();
                }
                setCurrentAudio(file);
                setTimeout(() => {
                    if (audioRef.current) {
                        audioRef.current.volume = volume;
                        audioRef.current.play();
                        setIsPlaying(true);
                    }
                }, 100);
            };

            const togglePlayPause = () => {
                if (audioRef.current) {
                    if (isPlaying) {
                        audioRef.current.pause();
                    } else {
                        audioRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };

            const deleteFile = (fileId) => {
                if (window.confirm('Êtes-vous sûr de vouloir supprimer ce fichier ?')) {
                    setAudioFiles(audioFiles.filter(f => f.id !== fileId));
                    const newTags = {...nfcTags};
                    Object.keys(newTags).forEach(tagId => {
                        if (newTags[tagId] === fileId) {
                            delete newTags[tagId];
                        }
                    });
                    setNfcTags(newTags);
                    if (currentAudio?.id === fileId) {
                        setCurrentAudio(null);
                        setIsPlaying(false);
                    }
                }
            };

            const updateFileName = (fileId) => {
                setAudioFiles(audioFiles.map(f => 
                    f.id === fileId ? {...f, name: editName} : f
                ));
                setEditingFile(null);
                setEditName('');
            };

            const updateCategory = (fileId, category) => {
                setAudioFiles(audioFiles.map(f => 
                    f.id === fileId ? {...f, category} : f
                ));
            };

            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return mins + ':' + secs.toString().padStart(2, '0');
            };

            const handleTimeUpdate = () => {
                if (audioRef.current) {
                    setProgress((audioRef.current.currentTime / audioRef.current.duration) * 100);
                }
            };

            const handleLoadedMetadata = () => {
                if (audioRef.current) {
                    setDuration(audioRef.current.duration);
                }
            };

            const handleProgressClick = (e) => {
                if (audioRef.current) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audioRef.current.currentTime = pos * audioRef.current.duration;
                }
            };

            const handleVolumeChange = (e) => {
                const newVolume = parseFloat(e.target.value);
                setVolume(newVolume);
                if (audioRef.current) {
                    audioRef.current.volume = newVolume;
                }
            };

            const filteredFiles = filterCategory === 'Tous' 
                ? audioFiles 
                : audioFiles.filter(f => f.category === filterCategory);

            useEffect(() => {
                if (mode === 'player' && !isScanning && audioFiles.length > 0) {
                    startNFCReader();
                }
            }, [mode, audioFiles.length]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-emerald-950 via-green-900 to-teal-900 text-white p-4 relative overflow-hidden">
                    {/* Décorations de branches */}
                    <div className="absolute top-0 left-0 w-64 h-64 opacity-20 pointer-events-none">
                        <svg viewBox="0 0 200 200" className="w-full h-full">
                            <path d="M10,10 Q30,40 50,30 T90,50 L85,55 Q60,45 40,60 T10,80" stroke="currentColor" fill="none" strokeWidth="3" className="text-green-400"/>
                            <circle cx="55" cy="35" r="3" fill="currentColor" className="text-green-300"/>
                            <circle cx="75" cy="45" r="3" fill="currentColor" className="text-green-300"/>
                        </svg>
                    </div>

                    <div className="max-w-6xl mx-auto relative z-10">
                        <div className="mb-8 text-center relative">
                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full mb-4 shadow-2xl">
                                <Icons.Music />
                            </div>
                            <h1 className="text-5xl font-bold mb-2 bg-gradient-to-r from-green-300 via-emerald-300 to-teal-300 bg-clip-text text-transparent">
                                Audio NFC Player
                            </h1>
                            <p className="text-green-200 text-lg">Scannez et écoutez vos sons de la nature</p>
                            
                            {mode === 'player' && (
                                <button
                                    onClick={() => setShowPasswordModal(true)}
                                    className="absolute top-0 right-0 p-3 bg-green-700/50 hover:bg-green-600/70 rounded-full backdrop-blur-lg border border-green-500/30 transition-all duration-300 hover:scale-110 shadow-xl"
                                >
                                    <Icons.Settings />
                                </button>
                            )}

                            {mode === 'admin' && (
                                <button
                                    onClick={() => setMode('player')}
                                    className="absolute top-0 right-0 px-4 py-2 bg-green-700/50 hover:bg-green-600/70 rounded-full backdrop-blur-lg border border-green-500/30 transition-all duration-300 shadow-xl text-sm font-semibold"
                                >
                                    Retour au lecteur
                                </button>
                            )}
                        </div>

                        {/* Modal de mot de passe */}
                        {showPasswordModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                <div className="bg-gradient-to-br from-green-900/90 to-emerald-900/90 backdrop-blur-xl rounded-3xl p-8 border border-green-500/30 shadow-2xl max-w-md w-full">
                                    <div className="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full mb-6 mx-auto">
                                        <Icons.Lock />
                                    </div>
                                    <h2 className="text-2xl font-bold mb-4 text-center">Administration</h2>
                                    <p className="text-green-200 mb-6 text-center">Entrez le mot de passe pour accéder aux paramètres</p>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                                        placeholder="Mot de passe"
                                        className={'w-full px-4 py-3 bg-white/10 rounded-xl border focus:outline-none focus:border-green-400 mb-4 text-center text-lg ' + (passwordError ? 'border-red-500' : 'border-green-500/30')}
                                    />
                                    {passwordError && (
                                        <p className="text-red-400 text-sm text-center mb-4">❌ Mot de passe incorrect</p>
                                    )}
                                    <div className="flex gap-3">
                                        <button
                                            onClick={handlePasswordSubmit}
                                            className="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-xl font-semibold transition-all duration-300 shadow-lg"
                                        >
                                            Valider
                                        </button>
                                        <button
                                            onClick={() => { setShowPasswordModal(false); setPassword(''); setPasswordError(false); }}
                                            className="flex-1 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-semibold transition-all duration-300"
                                        >
                                            Annuler
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {!nfcSupported && (
                            <div className="mb-6 bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/50 rounded-2xl p-6 text-center backdrop-blur-lg">
                                <div className="text-4xl mb-2">⚠️</div>
                                <div className="font-semibold text-lg mb-1">NFC non supporté</div>
                                <div className="text-sm text-red-200">Cette application nécessite Chrome sur Android avec NFC activé</div>
                            </div>
                        )}

                        {scanMessage && (
                            <div className="mb-6 bg-gradient-to-r from-green-500/30 to-emerald-500/30 border border-green-400/50 rounded-2xl p-6 text-center backdrop-blur-lg animate-pulse shadow-xl">
                                <div className="text-2xl mb-2">
                                    <Icons.Scan />
                                </div>
                                <div className="text-xl font-semibold">{scanMessage}</div>
                            </div>
                        )}

                        {/* MODE LECTEUR */}
                        {mode === 'player' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-xl rounded-3xl p-12 border border-green-500/30 shadow-2xl">
                                    <div className="text-center">
                                        <div className="mb-8 flex justify-center">
                                            <div style={{width: '120px', height: '120px'}}>
                                                <Icons.Scan />
                                            </div>
                                        </div>
                                        <h2 className="text-4xl font-bold mb-4 bg-gradient-to-r from-green-300 to-emerald-300 bg-clip-text text-transparent">
                                            {isScanning ? 'Prêt à scanner 🌿' : 'Initialisation...'}
                                        </h2>
                                        <p className="text-green-200 text-xl mb-6">
                                            Approchez un tag NFC de votre appareil
                                        </p>
                                        <div className="flex items-center justify-center gap-4 text-sm text-green-300">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                {audioFiles.length} fichiers disponibles
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-emerald-500 rounded-full"></div>
                                                {Object.keys(nfcTags).length} tags configurés
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {currentAudio && (
                                    <div className="bg-gradient-to-br from-green-900/50 to-emerald-900/50 backdrop-blur-xl rounded-3xl p-8 border border-green-500/30 shadow-2xl">
                                        <div className="flex items-center gap-6 mb-6">
                                            <div className="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-xl">
                                                <Icons.Music />
                                            </div>
                                            <div className="flex-1">
                                                <div className="text-sm text-green-300 mb-1">En lecture</div>
                                                <h3 className="text-2xl font-bold mb-1">{currentAudio.name}</h3>
                                                <div className="text-sm text-green-200">{currentAudio.category}</div>
                                            </div>
                                            <button
                                                onClick={togglePlayPause}
                                                className="w-16 h-16 bg-gradient-to-br from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-full flex items-center justify-center transition-all duration-300 shadow-xl hover:scale-110"
                                            >
                                                {isPlaying ? <Icons.Pause /> : <Icons.Play />}
                                            </button>
                                        </div>

                                        <div className="space-y-4">
                                            <div 
                                                className="h-2 bg-white/20 rounded-full cursor-pointer overflow-hidden"
                                                onClick={handleProgressClick}
                                            >
                                                <div 
                                                    className="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-100"
                                                    style={{ width: progress + '%' }}
                                                ></div>
                                            </div>
                                            
                                            <div className="flex justify-between text-sm text-green-300">
                                                <span>{formatTime(audioRef.current?.currentTime || 0)}</span>
                                                <span>{formatTime(duration)}</span>
                                            </div>

                                            <div className="flex items-center gap-4">
                                                <Icons.Volume2 />
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="1"
                                                    step="0.01"
                                                    value={volume}
                                                    onChange={handleVolumeChange}
                                                    className="flex-1 h-2 bg-white/20 rounded-full cursor-pointer"
                                                />
                                                <span className="text-sm text-green-300 w-12 text-right">{Math.round(volume * 100)}%</span>
                                            </div>
                                        </div>

                                        <audio
                                            ref={audioRef}
                                            src={currentAudio.url}
                                            onTimeUpdate={handleTimeUpdate}
                                            onLoadedMetadata={handleLoadedMetadata}
                                            onEnded={() => setIsPlaying(false)}
                                            onPlay={() => setIsPlaying(true)}
                                            onPause={() => setIsPlaying(false)}
                                            className="hidden