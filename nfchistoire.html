<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Histoire NFC</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  select, button { margin: 5px; padding: 10px; font-size: 16px; }
</style>
</head>
<body>
<h1>Histoire NFC</h1>
<p id="status">Approche un tag NFC...</p>

<!-- Choix audio en ligne pour associer aux tags -->
<label for="audioSelect">Associer un audio au tag :</label>
<select id="audioSelect">
  <option value="">-- Choisir un audio --</option>
  <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Audio 1</option>
  <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Audio 2</option>
</select>
<button id="associateBtn">Associer au tag NFC actuel</button>

<audio id="player" controls></audio>

<script>
const status = document.getElementById('status');
const player = document.getElementById('player');
const audioSelect = document.getElementById('audioSelect');
const associateBtn = document.getElementById('associateBtn');

// Récupérer les associations depuis LocalStorage
let tagAudioMap = {};
const savedData = localStorage.getItem('tagAudioMap');
if (savedData) tagAudioMap = JSON.parse(savedData);

let currentTag = null;

// Associer audio au tag actuel
associateBtn.addEventListener('click', () => {
  if (!currentTag) {
    alert("Scanne d'abord un tag NFC pour l'associer !");
    return;
  }
  const audioURL = audioSelect.value;
  if (!audioURL) {
    alert("Choisis un audio à associer !");
    return;
  }
  tagAudioMap[currentTag] = audioURL;
  localStorage.setItem('tagAudioMap', JSON.stringify(tagAudioMap));
  status.textContent = `Audio associé au tag : ${currentTag}`;
});

// Vérification Web NFC
if ('NDEFReader' in window) {
  const ndef = new NDEFReader();
  ndef.scan().then(() => {
    status.textContent = "Prêt à lire un tag NFC";
    ndef.onreadingerror = () => status.textContent = "Erreur de lecture NFC";
    ndef.onreading = event => {
      const decoder = new TextDecoder();
      let tagData = "";
      for (const record of event.message.records) {
        tagData += decoder.decode(record.data);
      }
      currentTag = tagData;
      status.textContent = "Tag détecté : " + tagData;

      if (tagAudioMap[tagData]) {
        player.src = tagAudioMap[tagData];
        player.play();
      } else {
        status.textContent += " (aucun audio associé)";
      }
    };
  }).catch(error => {
    status.textContent = "Impossible de démarrer NFC : " + error;
  });
} else {
  status.textContent = "Web NFC non supporté sur ce navigateur";
}
</script>
</body>
</html>